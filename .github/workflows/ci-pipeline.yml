name: Node.js CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [ main, develop ]

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE_NAME: mynodeapp
  NODE_VERSION: '18'

jobs:
  # Job 1: Build, Test, and Scan
  build-test-scan:
    name: Build, Test & Security Scan
    runs-on: ubuntu-latest
    # Skip if commit is from GitHub Actions Bot
    if: github.actor != 'github-actions[bot]' && !contains(github.event.head_commit.message, '[skip ci]')

    permissions:
      contents: read
      security-events: write 
      actions: read
    
    outputs:
      image-tag: ${{ steps.meta.outputs.image-tag }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run ESLint
      run: npm run lint
    
    - name: Run tests with coverage
      run: npm test
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: always()
      with:
        files: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
    
    - name: Security audit
      run: npm audit --audit-level=moderate
      continue-on-error: true
    
    - name: Run Trivy filesystem scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-fs-results.sarif'
        severity: 'CRITICAL'
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-fs-results.sarif'
    
    - name: Generate image metadata
      id: meta
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        IMAGE_TAG="${SHORT_SHA}-${TIMESTAMP}"
        echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
        echo "Generated image tag: ${IMAGE_TAG}"
    
    - name: Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        load: true
        tags: |
          ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          NODE_ENV=production
    
    - name: Run Trivy image scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL'
    
    - name: Test Docker image
      run: |
        # Start container
        docker run -d \
          --name test-container \
          -p 8080:8080 \
          ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        
        # Wait for container to be ready
        sleep 5
        
        # Test health endpoint
        curl -f http://localhost:8080/health || exit 1
        
        # Test root endpoint
        curl -f http://localhost:8080/ || exit 1
        
        # NEW: Test metrics endpoint
        curl -f http://localhost:8080/metrics || exit 1
        echo "âœ… Metrics endpoint is working!"
        
        # Stop container
        docker stop test-container
        docker rm test-container
        
        echo "âœ… Container tests passed!"
    
    - name: Push image to ACR
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest
        echo "âœ… Image pushed: ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

  # Job 2: Update Kubernetes Manifest
  update-manifest:
    name: Update K8s Manifest
    needs: build-test-scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GIT_TOKEN }}
        fetch-depth: 0
    
    - name: Update deployment manifest
      run: |
        IMAGE_TAG="${{ needs.build-test-scan.outputs.image-tag }}"
        FULL_IMAGE="${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        
        echo "Updating k8s/deployment.yaml with image: ${FULL_IMAGE}"
        
        # Update image in deployment.yaml
        sed -i "s|image:.*mynodeapp:.*|image: ${FULL_IMAGE}|" k8s/deployment.yaml
        
        # Verify the change
        echo "Updated deployment.yaml:"
        grep "image:" k8s/deployment.yaml
    
    - name: Commit and push changes
      run: |
        IMAGE_TAG="${{ needs.build-test-scan.outputs.image-tag }}"
        
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        git add k8s/deployment.yaml
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        git commit -m "ðŸš€ Deploy: Update image to ${IMAGE_TAG} [skip ci]

        - Image: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}
        - Commit: ${{ github.sha }}
        - Triggered by: ${{ github.actor }}"
        
        git push origin main
        
        echo "âœ… Manifest updated! ArgoCD will sync the changes."

  # Job 3: Apply Monitoring Configs (NEW)
  apply-monitoring-configs:
    name: Apply Monitoring Configs
    needs: [build-test-scan, update-manifest]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set AKS context
      run: |
        az aks get-credentials \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --name ${{ secrets.CLUSTER_NAME }} \
            --admin \
            --overwrite-existing

    - name: Apply ServiceMonitor
      run: |
        echo "Applying ServiceMonitor for app metrics..."
        kubectl apply -f k8s/servicemonitor.yaml
        
        # Verify it was created
        kubectl get servicemonitor mynodeapp-metrics -n default
        
        echo "âœ… ServiceMonitor applied successfully!"

    - name: Apply PrometheusRule (Alert Rules)
      run: |
        echo "Applying Prometheus alert rules..."
        kubectl apply -f k8s/prometheus-rules.yaml
        
        # Verify it was created
        kubectl get prometheusrule mynodeapp-alerts -n monitoring
        
        echo "âœ… Alert rules applied successfully!"
    
    - name: Verify monitoring setup
      run: |
        echo "Checking if Prometheus is scraping the app..."
        
        # Check if ServiceMonitor is picked up by Prometheus
        kubectl get servicemonitor -n default
        
        echo ""
        echo "ðŸ“Š Monitoring Status:"
        echo "- ServiceMonitor: âœ… Applied"
        echo "- PrometheusRule: âœ… Applied"
        echo ""
        echo "Prometheus should start scraping metrics within 30 seconds."
        echo "Check Prometheus targets: kubectl port-forward -n monitoring svc/monitoring-kube-prometheus-prometheus 9090:9090"

  # Job 4: Notify on Success
  notify-success:
    name: Notify Deployment
    needs: [build-test-scan, update-manifest, apply-monitoring-configs]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deployment summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ needs.build-test-scan.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Monitoring" >> $GITHUB_STEP_SUMMARY
        echo "- ServiceMonitor: âœ… Applied" >> $GITHUB_STEP_SUMMARY
        echo "- Alert Rules: âœ… Applied" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Image pushed to ACR, manifest updated, and monitoring configured. ArgoCD will deploy automatically." >> $GITHUB_STEP_SUMMARY